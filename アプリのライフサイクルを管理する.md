<!-- TOC -->

- [アプリのライフサイクルを管理する](#アプリのライフサイクルを管理する)
  - [概要](#概要)
  - [Scene ベースのライフサイクル イベントに対応する](#scene-ベースのライフサイクル-イベントに対応する)
  - [アプリベースのライフサイクルイベントへの対応](#アプリベースのライフサイクルイベントへの対応)
  - [その他の重要なイベントへの対応](#その他の重要なイベントへの対応)

<!-- /TOC -->
# アプリのライフサイクルを管理する

[Managing Your App's Life Cycle](https://developer.apple.com/documentation/uikit/app_and_environment/managing_your_app_s_life_cycle)

アプリがフォアグラウンドまたはバックグラウンドにあるときにシステム通知に応答し、その他の重要なシステム関連イベントを処理します。

## 概要

アプリの現在の状態によって、そのアプリがいつでもできることとできないことが決まります。

例えば、フォアグラウンドアプリはユーザーの注意を引くため、CPU などのシステムリソースよりも優先されます。
対照的に、バックグラウンドのアプリは、画面外にあるため、できる限り作業は少なく、できれば何もしない必要があります。

アプリの状態が変化すると、それに応じて動作を調整する必要があります。

アプリの状態が変化すると、UIKit は適切なデリゲートオブジェクトのメソッドを呼び出すことで通知します。

- iOS 13 以降では、UISceneDelegate オブジェクトを使用して、Scene ベースのアプリのライフサイクルイベントに応答します。
- iOS 12 以前の iOS では、UIApplicationDelegate オブジェクトを使ってライフサイクルイベントに応答します。

> 注意事項
> アプリのシーンサポートを有効にした場合、iOS 13 以降では、iOS は常にあなたのシーンデリゲートを使用します。iOS 12 以前のバージョンでは、システムはアプリのデリゲートを使用します。

## Scene ベースのライフサイクル イベントに対応する

アプリが Scene をサポートしている場合、UIKit はそれぞれに個別のライフサイクルイベントを配信します。

Scene は、デバイス上で実行されているアプリの UI の 1 つのインスタンスを表します。
ユーザーは各アプリに複数の Scene を作成し、別々に表示・非表示にすることができます。

各 Scene にはそれぞれ独自のライフサイクルがあるため、それぞれが異なる実行状態になることがあります。
たとえば、あるシーンはフォアグラウンドにあり、他のシーンはバックグラウンドにあったり、サスペンドされていたりすることがあります。

> 重要なこと
> Scene のサポートはオプトイン機能です。基本的なサポートを有効にするには、[アプリがサポートする Scene の指定](https://developer.apple.com/documentation/uikit/app_and_environment/scenes/specifying_the_scenes_your_app_supports) で説明されているように、UIApplicationSceneManifest キーをアプリの Info.plist ファイルに追加します。

次の図は、シーンの状態遷移を示しています。

ユーザーやシステムがアプリに新しい Scene を要求すると、UIKit はそれを作成し、アタッチされていない状態にします。

ユーザーが要求した Scene は、スクリーン上に表示されるフォアグラウンドに素早く移動します。
システムから要求された Scene は通常、イベントを処理するためにバックグラウンドに移動します。
たとえば、システムは位置情報イベントを処理するためにバックグラウンドで Scene を起動することがあります。

ユーザーがアプリの UI を解除すると、UIKit は関連する Scene をバックグラウンド状態に移動し、最終的にはサスペンド状態に移動します。
UIKit はいつでもバックグラウンドまたはサスペンドされた Scene を切断してリソースを回収し、その Scene をアタッチされていない状態に戻すことができます。

![]()
<img width="500" src="./images/Managing-Your-App's-Life-Cycle/024b99c5-4ab6-4ee0-bb41-6e6426ec6a64.png">

以下のタスクを実行するために Scene トランジションを使用します。

- UIKit が Scene をアプリに接続するとき、Scene の初期 UI を設定し、Scene が必要とするデータをロードします。
- フォアグラウンドアクティブ状態に遷移するときは、UI を設定し、ユーザーと対話する準備をします。詳細は、「フォアグラウンドで実行する UI の準備」を参照してください。
- フォアグラウンド アクティブ状態から抜けたら、データを保存してアプリの動作を静かにします。詳細は、「バックグラウンドで実行するための UI の準備」を参照してください。
- バックグラウンド状態に入ったら、重要なタスクを終了し、できるだけ多くのメモリを解放し、アプリのスナップショットに備えます。詳細は、「UI をバックグラウンドで実行する準備」を参照してください。
- Scene の切断時には、シーンに関連付けられた共有リソースをクリーンアップします。
- Scene 関連のイベントに加えて、UIApplicationDelegate オブジェクトを使用してアプリの起動に応答する必要があります。アプリの起動時に何をすべきかについては、「アプリの起動に応答する」を参照してください。

## アプリベースのライフサイクルイベントへの対応

iOS 12 以前、および Scene をサポートしていないアプリでは、UIKit はすべてのライフサイクルイベントを UIApplicationDelegate オブジェクトに配信します。
アプリデリゲートは、個別の画面に表示されるものを含め、アプリのすべてのウィンドウを管理します。
その結果、アプリの状態遷移は、外部ディスプレイ上のコンテンツを含むアプリの UI 全体に影響を与えます。

次の図は、アプリデリゲートオブジェクトに関係する状態遷移を示しています。
起動後、UI が画面に表示されようとしているかどうかに応じて、システムはアプリを非アクティブ状態またはバックグラウンド状態にします。
フォアグラウンドに起動すると、システムは自動的にアプリをアクティブ状態に遷移させます。その後、アプリが終了するまでアクティブとバックグラウンドの間で状態が変化します。

<img width="500" src="./images/Managing-Your-App's-Life-Cycle/024b99c5-4ab6-4ee0-bb41-6e6426ec6a64.png">

アプリのトランジションを使用して、次のタスクを実行します。

- 起動時に、アプリのデータ構造と UI を初期化します。アプリの起動時の対応」を参照してください。
- 起動時には、アプリのデータ構造と UI を初期化します。詳細は、「フォアグラウンドで実行する UI の準備」を参照してください。
- 非アクティブ化時には、データを保存し、アプリの動作を停止します。UI をバックグラウンドで実行する準備」を参照してください。
- バックグラウンド状態に入ったら、重要なタスクを終了し、できるだけ多くのメモリを解放し、アプリのスナップショットに備えます。詳細は、「UI をバックグラウンドで実行する準備」を参照してください。
- 終了時には、すべての作業を直ちに停止し、共有リソースを解放します。詳細は、『アプリケーション WillTerminate(\_:)』を参照してください。

## その他の重要なイベントへの対応

ライフサイクルイベントの処理に加えて、アプリは次の表に記載されているイベントを処理できるように準備しておく必要があります。
これらのイベントのほとんどを処理するには、UIApplicationDelegate オブジェクトを使用します。
場合によっては、通知を使用して処理できる場合もあり、アプリの他の部分から応答できるようになります。

|                                                   |                                                                                                                                                                                    |
| ------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| メモリ警告                                        | アプリのメモリ使用量が多すぎる場合に受信されます。アプリが使用するメモリの量を減らしてください。                                                                                   |
| 保護されたデータが利用可能になる/利用できなくなる | ユーザがデバイスをロックまたはロック解除したときに受信する。applicationProtectedDataDidBecomeAvailable(_:) および applicationProtectedDataWillBecomeUnavailable(_:) を参照のこと。 |
| ハンドオフタスク                                  | NSUserActivity オブジェクトを処理する必要があるときに受け取ります。application(\_:didUpdate:)を参照してください。                                                                  |
| 時間の変更                                        | 電話会社が時刻更新を送信するときなど、いくつかの異なる時刻変更に対して受信します。applicationSignificantTimeChange(\_:) を参照してください。                                       |
| URL を開く                                        | アプリがリソースを開く必要があるときに受け取ります。application(\_:open:options:) を参照してください。                                                                             |
